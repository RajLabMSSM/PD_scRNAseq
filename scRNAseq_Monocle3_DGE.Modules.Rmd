---
title: "PD_scRNAseq: Monocle3 DGE & Modules" 
author: "<h3>Author</h3>Brian M. Schilder, Bioinformatician II"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document: 
    theme: spacelab
    highlight: zenburn 
    code_folding: show 
    toc: true 
    toc_float: true
    smooth_scroll: true
    number_sections: false 
    self_contained: true
params:
  subsetGenes: "protein_coding" #FALSE
  subsetCells: 500 #FALSE
  resolution: 0.6
  resultsPath: "./Results"
  nCores: 2
  perplexity: 30
editor_options: 
  chunk_output_type: inline
---

# Setup 

```{r setup, dpi = 600, warning=F, message=F}
start_time <- Sys.time() 

#### #### Load Objects & Functions #### #### 
######################################################
# Import functions
root = "./"
source(file.path(root,"MAIN.R"))
import_parameters(params)
# load("Results/Current_Pipeline/scRNAseq_results.RData")
load(file.path(resultsPath, "scRNAseq_results.RData")) 
######################################################


#### #### PACKAGES #### #### 
######################################################
print("Written using: Seurat version* 2.3.4 2018-07-17")
# https://satijalab.org/seurat/install.html
library(Seurat) #
paste("Seurat", packageVersion("Seurat")) 
# library(monocle) # BiocManager::install("monocle")   
# paste("monocle", packageVersion("monocle")) 
library(monocle3)
paste("monocle3", packageVersion("monocle3")) 
library(garnett) # devtools::install_github("cole-trapnell-lab/garnett")
paste("garnett", packageVersion("garnett"))
 
library(cowplot) 
library(ggplot2)
library(dplyr) 
library(data.table) 
library(readxl) 
library(reshape2)
library(ggrepel)
library(plotly)
library(GeneOverlap) # BiocManager::install("GeneOverlap") 
######################################################


# Exporting 3D plots 
knitr::knit_hooks$set(webgl = rgl::hook_webgl)
dge_limit <- F # 100
nCores <- 4#parallel::detectCores()
set.seed(2019)


# Load preprocessed data
readRDS("./Data/monocle3_CDS.RData")
```

# Differential Gene Expression

Detect whether or not to limit DGE analysis to only the top N most variable genes.

```{r Differential Gene Expression}
# DGE limiter
if(dge_limit){
  cds_DGE <- cds[var.genes[1:dge_limit],]
  print(paste0("Testing only the top ",dge_limit," most variable genes in DGE analysis."))
} else{
  cds_DGE <- cds
  print(paste0("Testing all ",dim(cds)[1]," genes in DGE analysis."))
} 
# DGE distribution type
expression_family <- "quasipoisson" # Recommended by Monocle3 authors for most cases.
within_clusters <- c(1,2)
```

## Across Clusters

### PD vs. Control

```{r Across Clusters: PD vs. Control} 
dge.dx <- monocle3_DGE(cds_DGE = cds_DGE,
                           variable = "dx",
                           nCores = nCores, 
                           expression_family = expression_family,
                           plot_volcano = T, 
                           results_path = "./Results/across_PD.vs.Ctrl.txt") 
createDT(dge.dx)
```

### PD vs. GBA

```{r Across Clusters: PD vs. GBA} 
dge.mut <- monocle3_DGE(cds_DGE = cds_DGE,
                           variable = "dx",
                           variable_subsets = c("PD","GBA"),
                           nCores = nCores, 
                           expression_family = expression_family,
                           plot_volcano = T, 
                           results_path = "./Results/across_PD.vs.GBA.txt") 
createDT(dge.mut)
```

### Canonical vs. Intermediate Monocytes

- Compare all Canonical Monocytes (**Cluster 1**) to all Intermediate Monocytes (**Cluster 2**), regardless of disease status.

```{r Across Clusters: Canonical vs. Intermediate Monocytes}
dge.clust <- monocle3_DGE(cds_DGE = cds_DGE,
                           variable = "Cluster", 
                           variable_subsets = c(1,2),
                           nCores = nCores, 
                           expression_family = expression_family,
                           plot_volcano = T, 
                          results_path = "./Results/across_Clust1.vs.Clust2.txt") 
createDT(dge.clust)
```


## Within Clusters

### Disease {.tabset .tabset-fade .tabset-pills}

- Compare PD vs. Controls DGE within each cluster.  
- **Cluster 1** = Canonical Monocytes, **Cluster 2** = Intermediate Monocytes.  

```{r Within Clusters: Disease, results="asis"}
for (clust in within_clusters){
  cat("\n")
  cat("####",clust,"\n")
  cds_clust <- cds_DGE[,pData(cds_DGE)$Cluster==clust]
  dge.dx.clust <- monocle3_DGE(cds_DGE = cds_clust,
                           variable = "dx",  
                           nCores = nCores, 
                           expression_family = expression_family,
                           plot_volcano = T, 
                           results_path = paste0("./Results/within.Clust",clust,"_PD.vs.Ctrl.txt") )
  createDT(dge.dx.clust)
  cat("\n")
}
```

### PD vs. GBA {.tabset .tabset-fade .tabset-pills}

```{r Within Clusters: Mutations, results="asis"}
for (clust in within_clusters){
  cat("\n")
  cat("####",clust,"\n")
  cds_clust <- cds_DGE[,(pData(cds_DGE)$Cluster==clust)]
  dge.mut.clust <- monocle3_DGE(cds_DGE = cds_clust,
                           variable = "mut",  
                           variable_subsets = c("PD","GBA"),
                           nCores = nCores, 
                           expression_family = expression_family,
                           plot_volcano = T, 
                           results_path = paste0("./Results/within.Clust",clust,"_PD.vs.GBA.txt") ) 
  createDT(dge.mut.clust)
  cat("\n")
}
```


# Top Markers

Find genes that characterize each cluster.

```{r Top Markers}
marker_test_res = monocle3::top_markers(cds_DGE,
                                        group_cells_by="cluster", 
                                        reference_cells=1000, 
                                        cores=nCores)
# Cluster-specific markers
top_specific_markers = marker_test_res %>%
    filter(fraction_expressing >= 0.10) %>%
    group_by(cell_group) %>%
    top_n(4, pseudo_R2)
DT::datatable(top_specific_markers) 
# monocle3::plot_genes_by_group(cds,
#                               markers=top_specific_marker_ids,
#                               group_cells_by="partition",
#                               ordering_type="maximal_on_diag",
#                               max.size=3)
```


## Gene Expression Plots

```{r Gene Expression Plots}
# Violin
monocle3::plot_genes_violin(cds[c("CD14","FCGR3A"),], group_cells_by = "dx")

# UMAP 
monocle3::plot_cells(cds, 
                     genes=c("CD14","FCGR3A"), 
                     group_cells_by = "cluster",
                     show_trajectory_graph = F)
monocle3::plot_cells(cds, 
                     genes=unique(top_specific_markers$gene_id), 
                     group_cells_by = "cluster",
                     show_trajectory_graph = F)
# monocle3::plot_cells_3d(cds, genes="FCGR3A", show_trajectory_graph = F)
```



# Graph-autocorrelation Analysis 

Find genes of interest through graph-autocorrelation analysis.

```{r Graph-autocorrelation Analysis}
# pr_graph_test_res = monocle3::graph_test(cds, neighbor_graph="knn", cores=nCores)
# pr_deg_ids = row.names(subset(pr_graph_test_res, q_value < 0.05))
```

# Gene Modules

Identify co-expression modules.<br>
`find_gene_modules` essentially runs UMAP on the genes (as opposed to the cells) and then groups them into modules using Louvain community analysis.

```{r Gene Modules}
gene_module_df = monocle3::find_gene_modules(cds_DGE, 
                                             resolution=1e-2, 
                                             cores=nCores)
# Create pheatmap table
cell_group_df = tibble::tibble(cell=row.names(colData(cds)),
                               cell_group=clusters(cds)[colnames(cds)])
agg_mat = aggregate_gene_expression(cds, gene_module_df, cell_group_df)
row.names(agg_mat) = stringr::str_c("Module ", row.names(agg_mat))
colnames(agg_mat) = stringr::str_c("Cluster ", colnames(agg_mat))

pheatmap::pheatmap(agg_mat, cluster_rows=TRUE, cluster_cols=TRUE,
                   scale="column", clustering_method="ward.D2",
                   fontsize=6)
```

## Module Expression

```{r Module Expression}
monocle3::plot_cells(cds,
                     genes=gene_module_df,
                     group_cells_by="cluster",
                     color_cells_by="cluster",
                     show_trajectory_graph=F) #  rasterize = T (for super high-res figures)
```


